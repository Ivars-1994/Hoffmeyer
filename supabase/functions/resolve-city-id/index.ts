import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

// Allowed origins for CORS
const ALLOWED_ORIGINS = [
  'https://kammerjaeger-hoffmeyer.de',
  'https://www.kammerjaeger-hoffmeyer.de',
  'https://hoffmeyer.lovable.app',
  'http://localhost:5173'
];

function getCorsHeaders(origin: string | null) {
  const allowedOrigin = origin && ALLOWED_ORIGINS.includes(origin) 
    ? origin 
    : ALLOWED_ORIGINS[0];
    
  return {
    'Access-Control-Allow-Origin': allowedOrigin,
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
  };
}

// Import der kompletten Stadt-Map (alle 7000+ Eintr채ge)
const stadtMapContent = `{
  "1004576": "Aachen",
  "1004577": "Ahaus",
  "1004578": "Ahlen",
  "1004579": "Alfter",
  "1004580": "Alsdorf",
  "1004581": "Altenberge",
  "1004582": "Arnsberg",
  "1004583": "Attendorn",
  "1004584": "Bad Berleburg",
  "1004585": "Bad Oeynhausen",
  "1004586": "Bad Sassendorf",
  "1004587": "Baesweiler",
  "1004588": "Beckum",
  "1004589": "Bedburg",
  "1004590": "Bergheim",
  "1004591": "Bergisch Gladbach",
  "1004592": "Bergkamen",
  "1004593": "Bielefeld",
  "1004594": "Billerbeck",
  "1004595": "Bocholt",
  "1004596": "Bochum",
  "1004597": "Bonn",
  "1004598": "Borchen",
  "1004599": "Borken",
  "1004600": "Bornheim",
  "1004601": "Bottrop",
  "1004602": "Bunde",
  "1004603": "Burbach",
  "1004604": "Burscheid",
  "1004605": "Castrop-Rauxel",
  "1004606": "Coesfeld",
  "1004607": "Cologne",
  "1004608": "Detmold",
  "1004609": "Dormagen",
  "1004610": "Dorsten",
  "1004611": "Dortmund",
  "1004612": "Duisburg",
  "1004613": "Dulmen",
  "1004614": "Duren",
  "1004615": "Dusseldorf",
  "1004616": "Emmerich",
  "1004617": "Emsdetten",
  "1004618": "Ennepetal",
  "1004619": "Erftstadt",
  "1004620": "Erkelenz",
  "1004621": "Erkrath",
  "1004622": "Erwitte",
  "1004623": "Eschweiler",
  "1004624": "Espelkamp",
  "1004625": "Essen",
  "1004626": "Euskirchen",
  "1004627": "Everswinkel",
  "1004628": "Frechen",
  "1004629": "Freudenberg",
  "1004630": "Frondenberg",
  "1004631": "Gelsenkirchen",
  "1004632": "Gevelsberg",
  "1004633": "Goch",
  "1004634": "Grefrath",
  "1004635": "Greven",
  "1004636": "Grevenbroich",
  "1004637": "Gronau",
  "1004638": "Gummersbach",
  "1004639": "Gutersloh",
  "1004640": "Haan",
  "1004641": "Haltern am See",
  "1004642": "Hamm",
  "1004643": "Hattingen",
  "1004644": "Hatzfeld",
  "1004645": "Heiligenhaus",
  "1004646": "Heinsberg",
  "1004647": "Hemer",
  "1004648": "Hennef",
  "1004649": "Herdecke",
  "1004650": "Herford",
  "1004651": "Herne",
  "1004652": "Herten",
  "1004653": "Herzogenrath",
  "1004654": "Hiddenhausen",
  "1004655": "Hilden",
  "1004656": "Holzwickede",
  "1004657": "Horstel",
  "1004658": "Horstmar",
  "1004659": "Hoxter",
  "1004660": "Ratheim",
  "1004661": "Huckeswagen",
  "1004662": "Hurth",
  "1004663": "Ibbenburen",
  "1004664": "Iserlohn",
  "1004665": "Julich",
  "1004666": "Kaarst",
  "1004667": "Kall",
  "1004668": "Kempen",
  "1004669": "Kerpen",
  "1004670": "Kevelaer",
  "1004671": "Kierspe",
  "1004672": "Kirchlengern",
  "1004673": "Kleve",
  "1004674": "Korschenbroich",
  "1004675": "Krefeld",
  "1004676": "Kurten",
  "1004677": "Lage",
  "1004678": "Langenfeld",
  "1004679": "Lemgo",
  "1004680": "Lengerich",
  "1004681": "Leopoldshohe",
  "1004682": "Leverkusen",
  "1004683": "Linnich",
  "1004684": "Lippstadt",
  "1004685": "Lohmar",
  "1004686": "Lohne",
  "1004687": "Lubbecke",
  "1004688": "Ludenscheid",
  "1004689": "Ludinghausen",
  "1004690": "Lunen",
  "1004691": "Manheim",
  "1004692": "Marl",
  "1004693": "Marsberg",
  "1004694": "Mechernich",
  "1004695": "Meckenheim",
  "1004696": "Meerbusch",
  "1004697": "Meinerzhagen",
  "1004698": "Menden",
  "1004699": "Meschede",
  "1004700": "Mettmann",
  "1004701": "Minden",
  "1004702": "Moers",
  "1004703": "Monchengladbach",
  "1004704": "Monheim am Rhein",
  "1004705": "Morsbach",
  "1004706": "Mulheim",
  "1004707": "Munster",
  "1004708": "Neuss",
  "1004709": "Niederkassel",
  "1004710": "Oberhausen",
  "1004711": "Oelde",
  "1004712": "Olfen",
  "1004713": "Olpe",
  "1004714": "Overath",
  "1004715": "Paderborn",
  "1004716": "Plettenberg",
  "1004717": "Porta Westfalica",
  "1004718": "Pulheim",
  "1004719": "Ratingen",
  "1004720": "Recke",
  "1004721": "Recklinghausen",
  "1004722": "Remscheid",
  "1004723": "Rheda-Wiedenbruck",
  "1004724": "Rheine",
  "1004725": "County of Rietberg",
  "1004726": "Roetgen",
  "1004727": "Rosrath",
  "1004728": "Salzkotten",
  "1004729": "Schalksmuhle",
  "1004730": "Schwelm",
  "1004731": "Schwerte",
  "1004732": "Senden",
  "1004733": "Siegburg",
  "1004734": "Siegen",
  "1004735": "Soest",
  "1004736": "Solingen",
  "1004737": "Sprockhovel",
  "1004738": "Sankt Augustin",
  "1004739": "Stadtlohn",
  "1004740": "Steinfurt",
  "1004741": "Steinhagen",
  "1004742": "Stolberg (Rhineland)",
  "1004743": "Straelen",
  "1004744": "Tonisvorst",
  "1004745": "Troisdorf",
  "1004746": "Unna",
  "1004747": "Velbert",
  "1004748": "Verl",
  "1004749": "Versmold",
  "1004750": "Viersen",
  "1004751": "Vlotho",
  "1004752": "Vreden",
  "1004753": "Wachtberg",
  "1004754": "Wachtendonk",
  "1004755": "Walheim",
  "1004756": "Warburg",
  "1004757": "Warendorf",
  "1004758": "Weeze",
  "1004759": "Werdohl",
  "1004760": "Werl",
  "1004761": "Wermelskirchen",
  "1004762": "Wesel",
  "1004763": "Wetter",
  "1004764": "Wiehl",
  "1004765": "Willich",
  "1004766": "Winterberg",
  "1004767": "Wipperfurth",
  "1004768": "Witten",
  "1004769": "Wuppertal",
  "1004770": "Wurselen",
  "1004771": "Xanten",
  "1028816": "Hagen",
  "9048141": "Aldenhoven",
  "9048146": "Alpen",
  "9048151": "Altena",
  "9048156": "Anrochte",
  "9048161": "Ascheberg",
  "9048169": "Bad Driburg",
  "9048179": "Bad Honnef",
  "9048185": "Bad Munstereifel",
  "9048190": "Bad Salzuflen",
  "9048198": "Bad Wunnenberg",
  "9048202": "Balve",
  "9048219": "Bestwig",
  "9048229": "Blomberg",
  "9048233": "Bonen",
  "9048238": "Borgholzhausen",
  "9048243": "Brakel",
  "9048249": "Brilon",
  "9048254": "Bruggen",
  "9048256": "Bruhl",
  "9048259": "Buren",
  "9048269": "Datteln",
  "9048273": "Delbruck",
  "9048281": "Dinslaken",
  "9048288": "Drensteinfurt",
  "9048290": "Drolshagen",
  "9048307": "Eitorf",
  "9048308": "Elsdorf",
  "9048316": "Engelskirchen",
  "9048318": "Enger",
  "9048319": "Ennigerloh",
  "9048320": "Ense",
  "9048331": "Eslohe",
  "9048342": "Finnentrop",
  "9048363": "Geilenkirchen",
  "9048366": "Geldern",
  "9048370": "Gescher",
  "9048371": "Geseke",
  "9048374": "Gladbeck",
  "9048396": "Halle",
  "9048398": "Hamminkeln",
  "9048402": "Harsewinkel",
  "9048428": "Herzebrock-Clarholz",
  "9048431": "Hilchenbach",
  "9048448": "Horn-Bad Meinberg",
  "9048449": "Hovelhof",
  "9048450": "Huckelhoven",
  "9048451": "Hullhorst",
  "9048453": "Hunxe",
  "9048461": "Isselburg",
  "9048462": "Issum",
  "9048466": "Kalkar",
  "9048467": "Kamen",
  "9048468": "Kamp-Lintfort",
  "9048493": "Konigswinter",
  "9048497": "Kranenburg",
  "9048498": "Kreuztal",
  "9048510": "Leichlingen",
  "9048513": "Lennestadt",
  "9048521": "Lindlar",
  "9048528": "Lotte",
  "9048551": "Medebach",
  "9048567": "Mohnesee",
  "9048571": "Monschau",
  "9048574": "Much",
  "9048588": "Netphen",
  "9048589": "Nettetal",
  "9048592": "Neuenkirchen",
  "9048593": "Neuenrade",
  "9048597": "Neukirchen-Vluyn",
  "9048599": "Neunkirchen",
  "9048600": "Neunkirchen-Seelscheid",
  "9048612": "Niederkruchten",
  "9048616": "Nordkirchen",
  "9048618": "Norvenich",
  "9048619": "Nottuln",
  "9048620": "Numbrecht",
  "9048635": "Oer-Erkenschwick",
  "9048639": "Olsberg",
  "9048652": "Petershagen",
  "9048667": "Radevormwald",
  "9048668": "Raesfeld",
  "9048669": "Rahden",
  "9048676": "Rees",
  "9048679": "Reichshof",
  "9048682": "Reken",
  "9048686": "Rheinbach",
  "9048687": "Rheinberg",
  "9048694": "Rommerskirchen",
  "9048697": "Ruthen",
  "9048711": "Sassenberg",
  "9048721": "Schlangen",
  "9048722": "Schleiden",
  "9048724": "Schloss Holte-Stukenbrock",
  "9048727": "Schmallenberg",
  "9048742": "Schwalmtal",
  "9048755": "Sendenhorst",
  "9048757": "Simmerath",
  "9048773": "Steinheim",
  "9048777": "Stemwede",
  "9048786": "Sundern",
  "9048787": "Swisttal",
  "9048791": "Tecklenburg",
  "9048792": "Telgte",
  "9048808": "Ubach-Palenberg",
  "9048810": "Uedem",
  "9048820": "Velen",
  "9048825": "Voerde",
  "9048834": "Waldbrol",
  "9048844": "Waltrop",
  "9048847": "Warstein",
  "9048849": "Wegberg",
  "9048858": "Wenden",
  "9048863": "Werne",
  "9048866": "Wesseling",
  "9048879": "Wilnsdorf",
  "9048880": "Windeck",
  "9048891": "Wulfrath",
  "9048900": "Zulpich",
  "9060644": "Mitte",
  "9060645": "Bethel",
  "9060646": "Bochum-Innenstadt",
  "9060647": "Bonn-Zentrum",
  "9060648": "Sudstadt",
  "9060649": "Nordstadt",
  "9060653": "Koln-Altstadt-Nord",
  "9060654": "Koln-Altstadt-Sud",
  "9060655": "Koln-Neustadt-Sud",
  "9060656": "Koln-Neustadt-Nord",
  "9060657": "Innenstadt",
  "9060659": "Ruhrallee West",
  "9060660": "Westfalendamm-Nord",
  "9060661": "Aplerbecker Mark",
  "9060666": "Altstadt",
  "9060667": "Dellviertel",
  "9060669": "Alt-Hamborn",
  "9060670": "Neudorf-Nord",
  "9060671": "Dusseldorf-Stadtmitte",
  "9060672": "Dusseldorf-Unterbilk",
  "9060673": "Stadtbezirk 1",
  "9060674": "Dusseldorf-Pempelfort",
  "9060675": "Dusseldorf-Flingern",
  "9060676": "Sudviertel",
  "9060677": "Ruttenscheid",
  "9060699": "Uerdingen",
  "9060714": "Gladbach",
  "9060715": "Rheydt",
  "9060716": "Heyden",
  "9060718": "Kreuzviertel",
  "9060725": "Elberfeld-Mitte",
  "9060726": "Friedrich-Engels-Allee",
  "9060727": "Nordstadt",
  "9060728": "Ostersbaum",
  "9062588": "Flingern-Sud",
  "9062589": "Flingern Nord",
  "9062590": "Waldfeucht",
  "9062591": "Schoppingen",
  "9062592": "Havixbeck",
  "9062593": "Gangelt",
  "9062594": "Sudlohn",
  "9062595": "Legden",
  "9062596": "Rosendahl",
  "9062597": "Selfkant",
  "9062598": "Sonsbeck",
  "9062599": "Rhede",
  "9062600": "Heiden",
  "9062601": "Rheurdt",
  "9062602": "Heek",
  "9062603": "Schermbeck",
  "9062604": "Kerken",
  "9062605": "Juchen",
  "9068625": "Weilerswist",
  "9068719": "Ladbergen",
  "9068731": "Langerwehe",
  "9068739": "Niederzier",
  "9068773": "Merzenich",
  "9068880": "Lippetal",
  "9117068": "Borken",
  "9117069": "Wesel",
  "9117070": "Viersen",
  "9117071": "Rhein-Kreis Neuss",
  "9117072": "Duisburg",
  "9117073": "Mettmann",
  "9117076": "Wuppertal",
  "9117079": "Recklinghausen",
  "9117080": "Unna",
  "9117081": "Ennepe-Ruhr-Kreis",
  "9117086": "Markischer Kreis",
  "9117090": "Olpe",
  "9117094": "Warendorf",
  "9117095": "Coesfeld",
  "9117096": "Steinfurt",
  "9117104": "Minden-Lubbecke",
  "9117105": "Herford",
  "9117107": "Gutersloh",
  "9117109": "Lippe",
  "9117150": "Hoxter",
  "9117196": "Paderborn",
  "9117199": "Soest",
  "9117201": "Hochsauerlandkreis",
  "9117576": "Oberbergischer",
  "9117578": "Rheinisch-Bergischer Kreis",
  "9117580": "Rhein-Sieg-Kreis",
  "9117597": "Euskirchen",
  "9117598": "Rhein-Erft District",
  "9117601": "Aachen",
  "9117604": "Duren",
  "9117659": "Heinsberg",
  "9117660": "Kleve",
  "9117679": "Siegen-Wittgenstein",
  "9189190": "Eicken",
  "9189202": "Bochum-Linden",
  "9189271": "Titz",
  "9189280": "Westerkappeln",
  "9189479": "Hochdahl",
  "9189514": "Deutz",
  "9189540": "Liblar",
  "9189544": "Duissern",
  "9189603": "Beverungen",
  "9189666": "Katernberg",
  "9189743": "Niehl",
  "9190059": "Vettweiss",
  "9190148": "Schloss Neuhaus",
  "9190231": "Wassenberg",
  "9190569": "Hiltrup",
  "9190571": "Dusseldorf-Hafen",
  "9190915": "Poll",
  "9191017": "Kohlscheid",
  "9191029": "Epe",
  "9191080": "Holthausen",
  "9191269": "Friemersheim",
  "9191329": "Lintorf",
  "9191408": "Hamm",
  "9191412": "District 2",
  "9191589": "Bergneustadt",
  "9191689": "Bilderstockchen",
  "9191767": "Heerdt",
  "9191947": "Baerl",
  "9191988": "Bedburg-Hau",
  "9192093": "Hille",
  "9192203": "Lennep",
  "9192275": "Dellbruck",
  "9192407": "Lohausen",
  "9192497": "Rheindahlen-Land",
  "9192564": "Spenge",
  "9192644": "Stiepel",
  "9192662": "Unterrath",
  "9192689": "Dulken",
  "9192818": "Hochfeld",
  "9192953": "Sulz",
  "9193008": "Lobberich",
  "9193086": "Osterath",
  "9193263": "Oerlinghausen",
  "9193282": "Morsenbroich",
  "9193298": "Delbruck",
  "9193479": "Bockum-Hovel",
  "9193538": "Nippes",
  "9193586": "Quadrath-Ichendorf",
  "9193919": "Bad Laasphe",
  "9193935": "Rumeln-Kaldenhausen",
  "9194144": "Kettwig",
  "9194164": "Unterbach",
  "9194413": "Bad Lippspringe",
  "9194415": "Brauweiler",
  "9194450": "Bochum-Werne",
  "9194527": "Erle",
  "9194924": "Grengel",
  "9195097": "Bergheim",
  "9195199": "Marienheide",
  "9195246": "Brand",
  "9195267": "Elberfeld",
  "9195301": "Brambauer",
  "9195595": "Frechen",
  "9195654": "Sindorf",
  "9195662": "Monheim am Rhein",
  "9195797": "Hangelar",
  "9195872": "Wiedenbruck",
  "9195922": "Huckelhoven",
  "9196038": "Hohenlimburg",
  "9196141": "District 4",
  "9196155": "Spich",
  "9196165": "Porta Westfalica",
  "9196171": "Emmerich am Rhein",
  "9196211": "Ochtrup",
  "9196328": "Obrighoven-Lackhausen",
  "9196422": "Refrath",
  "9196434": "Buderich",
  "9196486": "District III",
  "9196577": "Dusseldorf-Rath",
  "9196599": "Heinsberg",
  "9196617": "Bismarck",
  "9196619": "Weidenau",
  "9196629": "Kuppersteg",
  "9196662": "Bornheim",
  "9196687": "Rheda",
  "9196717": "Repelen",
  "9196787": "Hagen",
  "9196798": "Opladen",
  "9196810": "Selm",
  "9196907": "Stadtmitte",
  "9196931": "Borghorst",
  "9197043": "Stadtbezirke I",
  "9197189": "Wegberg",
  "9197215": "Wiesdorf",
  "9197229": "Altenessen - Sud",
  "9197301": "Sankt Tonis",
  "9197307": "Nord",
  "9197308": "Gronau",
  "9197378": "Neheim",
  "9197391": "Borken",
  "9197426": "Hassel",
  "9197524": "Haltern am See",
  "9197571": "Bochum-Mitte",
  "9197635": "Halver",
  "9197868": "District 3",
  "9198052": "Nippes",
  "9198651": "Porz",
  "9198718": "Rodenkirchen",
  "9198758": "Duisburg-Mitte",
  "9198841": "Ehrenfeld",
  "9199176": "Lindenthal",
  "9207038": "Werther",
  "9207068": "Cronenberg",
  "9207182": "Dusseldorf-Ludenberg",
  "9207280": "Windberg",
  "9207404": "Wanheimerort",
  "9207500": "Stockum",
  "9207907": "Heisingen",
  "9208145": "Wipperfurth",
  "9208192": "Bochum-Westenfeld",
  "9208249": "Langenberg",
  "9208474": "Laer",
  "9208558": "Lindlar",
  "9208643": "Duisburg-Aldenrade",
  "9208648": "Hontrop",
  "9208672": "Zundorf",
  "9208699": "Waldniel",
  "9208826": "Barmen",
  "9208925": "Neukirchen",
  "9208962": "Rheinberg",
  "9208981": "Stadtbezirke IV",
  "9209035": "Dieringhausen",
  "9209049": "Jollenbeck",
  "9209090": "Preussisch Oldendorf",
  "9209115": "Borgentreich",
  "9209139": "District 8",
  "9209215": "Oberaden",
  "9209273": "Nachstebreck-Ost",
  "9209455": "Olpe",
  "9209503": "Munster-Kinderhaus",
  "9209562": "Halle",
  "9209594": "Hopsten",
  "9209604": "Hiltrop",
  "9209706": "Wittlaer",
  "9209775": "District 10",
  "9209788": "Manfort",
  "9209823": "Venn",
  "9210015": "Meschede",
  "9210160": "Rondorf",
  "9210280": "Beelen",
  "9210315": "Hervest",
  "9210442": "GI Worringen",
  "9210448": "Holweide",
  "9210539": "Ostbevern",
  "9210556": "Ubach",
  "9210560": "Eiserfeld",
  "9210583": "Stadtbezirke VII",
  "9210715": "Inden",
  "9210759": "Libur",
  "9210909": "Dunnwald",
  "9210936": "Metelen",
  "9210983": "Bedburg",
  "9211111": "Gremberghoven",
  "9211115": "Langenberg",
  "9211266": "Kaldenkirchen",
  "9211304": "Geilenkirchen",
  "9211366": "Buren",
  "9211382": "Kreuzau",
  "9211400": "Fischlaken",
  "9211456": "Karnap",
  "9211465": "Dankersen",
  "9211496": "Duisburg-Hochheide",
  "9211566": "Remscheid",
  "9211583": "Hamminkeln",
  "9211590": "Dellwig",
  "9211627": "Wickede",
  "9211643": "Neumuhl",
  "9211706": "District 9",
  "9211723": "Norf",
  "9211734": "Furth-Mitte",
  "9211768": "Wassenberg",
  "9211870": "Leithe",
  "9211923": "Ostheim",
  "9212219": "Dusseldorf-Kaiserswerth",
  "9212231": "Odenkirchen-Mitte",
  "9212457": "Waltrop",
  "9212854": "Fuhlingen",
  "9212883": "Augustdorf",
  "9212925": "Ubach-Palenberg",
  "9212964": "Nideggen",
  "9212986": "Horstel",
  "9213194": "Volmarstein",
  "9213212": "Hellenthal",
  "9213269": "Duisburg-Huckingen",
  "9213293": "Krefeld",
  "9213471": "Oberbarmen",
  "9213507": "Amshausen",
  "9213644": "Erftstadt",
  "9213666": "Angermund",
  "9213746": "Dahlem",
  "9213747": "Hurth",
  "9213799": "Lienen",
  "9213902": "Welver",
  "9213932": "Ruppichteroth",
  "9214209": "Brilon",
  "9214303": "Erkrath",
  "9214308": "Homberg",
  "9214328": "Wadersloh",
  "9214329": "Sennestadt",
  "9214410": "District 6",
  "9214472": "Vreden",
  "9214477": "Grossenbaum",
  "9214936": "Neubeckum",
  "9214950": "Schloss Holte",
  "9215123": "Heidhausen",
  "9215381": "Kerken",
  "9215385": "Sankt Augustin",
  "9215413": "Lugde",
  "9215517": "Blankenheim",
  "9215526": "Feldmark",
  "9215547": "Mennighuffen",
  "9215569": "Schieder-Schwalenberg",
  "9215650": "Stieghorst",
  "9215702": "Mettingen",
  "9215727": "Wettringen",
  "9215866": "Riemke",
  "9215885": "Lennestadt",
  "9215922": "Fuhlenbrock",
  "9216031": "Duisdorf",
  "9216130": "Herscheid",
  "9216132": "Stammheim",
  "9216208": "Hohenhaus",
  "9216403": "Horde",
  "9216534": "Asberg",
  "9216535": "Neuwerk",
  "9216546": "Gerthe",
  "9216597": "Elsen",
  "9216633": "Leichlingen (Rheinland)",
  "9216757": "Kirchhundem",
  "9216779": "Ennigloh",
  "9216786": "Worringen",
  "9216880": "Essen-Werden",
  "9217016": "Luttringhausen",
  "9217060": "Lichtenau",
  "9217129": "Oberbilk",
  "9217159": "Heiligenhaus",
  "9217322": "Scholven",
  "9217323": "Uellendahl-Katernberg",
  "9217383": "Bergkamen",
  "9217548": "Friedrichsfeld",
  "9217576": "Odenthal",
  "9217623": "Kalk",
  "9217662": "Nieheim",
  "9217678": "Bad Godesberg",
  "9217732": "Erndtebruck",
  "9217814": "Heimbach",
  "9217940": "Monchengladbach Ost",
  "9217953": "Schalke",
  "9218006": "Verl",
  "9218082": "Altenbochum",
  "9218240": "Wanheim-Angerhausen",
  "9218380": "Weidenpesch",
  "9218475": "Westhoven",
  "9218657": "Husten",
  "9218680": "Kupferdreh",
  "9218815": "Willebadessen",
  "9219023": "Junkersdorf",
  "9219163": "Extertal",
  "9219165": "Nottuln",
  "9219250": "Herzogenrath",
  "9219306": "Barntrup",
  "9219555": "Wickede",
  "9219693": "Vluyn",
  "9219746": "Suchteln",
  "9219861": "Hurtgenwald",
  "9219875": "Geisweid",
  "9219986": "Resse",
  "9220062": "Nettersheim",
  "9220444": "Mehlem",
  "9220843": "Uckendorf",
  "9220930": "Brake",
  "9220932": "Meschenich",
  "9220962": "Altenbeken",
  "9221036": "Reckenfeld",
  "9221049": "Niederaussem",
  "9221179": "Buchholz",
  "9221388": "Rodinghausen",
  "9221516": "Bruck",
  "9221584": "Kalletal",
  "9221617": "Hoxter",
  "9221671": "Bettrath-Hoven",
  "9221786": "Dusseldorf-Vennhausen",
  "9221836": "Bad Honnef",
  "9221844": "Dutzen",
  "9221872": "Dusseldorf-Gerresheim",
  "9221882": "Dusseldorf-Himmelgeist",
  "9222180": "Siegburg",
  "9222294": "Altenessen-Nord",
  "9222355": "Kleinenbroich",
  "9222483": "Salzkotten",
  "9222555": "Schonebeck",
  "9222599": "Dahlhausen",
  "9222690": "Vogelheim",
  "9222795": "Schildesche",
  "9043379": "32469",
  "9043382": "32369",
  "9043383": "32351",
  "9043740": "48493",
  "9043741": "48485",
  "9043742": "48565",
  "9043743": "48607",
  "9043745": "48599",
  "9043746": "48683",
  "9043747": "48619",
  "9043748": "48624",
  "9043749": "48612",
  "9043750": "48366",
  "9043751": "48727",
  "9043752": "48720",
  "9043753": "48653",
  "9043754": "48301",
  "9043755": "48249",
  "9043756": "48734",
  "9043757": "48712",
  "9043758": "46342",
  "9043759": "46359",
  "9043760": "46325",
  "9043761": "46414",
  "9043762": "46354",
  "9043763": "48703",
  "9043764": "48691",
  "9043765": "46399",
  "9043766": "46509",
  "9043767": "46499",
  "9043768": "46395",
  "9043769": "46348",
  "9043770": "46514",
  "9043771": "46485",
  "9043772": "46562",
  "9043773": "46569",
  "9043774": "46539",
  "9043775": "46147",
  "9043776": "47167",
  "9043777": "47166",
  "9043778": "47179",
  "9043779": "47178",
  "9043780": "46535",
  "9043781": "47475",
  "9043782": "47495",
  "9043783": "46487",
  "9043784": "46519",
  "9043785": "47661",
  "9043786": "47647",
  "9043787": "47506",
  "9043788": "47803",
  "9043789": "47906",
  "9043790": "47929",
  "9043791": "47918",
  "9043792": "41749",
  "9043793": "41068",
  "9043794": "41069",
  "9043795": "41747",
  "9043796": "41748",
  "9043797": "41066",
  "9043798": "41061",
  "9043799": "41065",
  "9043800": "47877",
  "9043801": "47804",
  "9043802": "47807",
  "9043803": "40670",
  "9043804": "41352",
  "9043805": "41564",
  "9043806": "41462",
  "9043807": "41464",
  "9043808": "41460",
  "9043809": "40549",
  "9043810": "40547",
  "9043811": "40474",
  "9043812": "40667",
  "9043813": "40668",
  "9043814": "40489",
  "9043815": "47055",
  "9043816": "47249",
  "9043817": "47229",
  "9043818": "47259",
  "9043819": "47809",
  "9043820": "47829",
  "9043821": "47800",
  "9043822": "47799",
  "9043823": "47447",
  "9043824": "47239",
  "9043825": "47198",
  "9043826": "47441",
  "9043827": "47445",
  "9043828": "47119",
  "9043829": "47228",
  "9043830": "47059",
  "9043831": "47051",
  "9043832": "47053",
  "9043833": "47057",
  "9043834": "47138",
  "9043835": "46045",
  "9043836": "46049",
  "9043837": "45476",
  "9043838": "45479",
  "9043839": "45478",
  "9043840": "45468",
  "9043841": "45475",
  "9043842": "46047",
  "9043843": "45359",
  "9043844": "45143",
  "9043845": "45127",
  "9043846": "45128",
  "9043847": "45147",
  "9043848": "45131",
  "9043849": "45133",
  "9043850": "45472",
  "9043851": "45470",
  "9043852": "45219",
  "9043853": "42579",
  "9043854": "40885",
  "9043855": "45481",
  "9043856": "47269",
  "9043857": "40880",
  "9043858": "40878",
  "9043859": "40472",
  "9043860": "40625",
  "9043861": "40235",
  "9043862": "40237",
  "9043863": "40477",
  "9043864": "40476",
  "9043865": "40470",
  "9043866": "40468",
  "9043867": "40545",
  "9043868": "40213",
  "9043869": "40225",
  "9043870": "40223",
  "9043871": "40221",
  "9043872": "41468",
  "9043873": "40589",
  "9043874": "40229",
  "9043875": "40591",
  "9043876": "40227",
  "9043877": "40233",
  "9043878": "40231",
  "9043879": "40627",
  "9043880": "40597",
  "9043881": "40599",
  "9043882": "40721",
  "9043883": "40699",
  "9043884": "40629",
  "9043885": "40882",
  "9043886": "42489",
  "9043887": "42327",
  "9043888": "40822",
  "9043889": "42781",
  "9043890": "40724",
  "9043891": "42697",
  "9043892": "42699",
  "9043893": "42653",
  "9043894": "42655",
  "9043895": "42659",
  "9043896": "42349",
  "9043897": "42119",
  "9043898": "42113",
  "9043899": "42285",
  "9043900": "42281",
  "9043901": "42555",
  "9043902": "45549",
  "9043903": "42553",
  "9043904": "42549",
  "9043905": "45239",
  "9043906": "42551",
  "9043907": "45257",
  "9043908": "45136",
  "9043909": "45307",
  "9043910": "45279",
  "9043911": "44869",
  "9043912": "44879",
  "9043913": "45525",
  "9043914": "44795",
  "9043915": "44799",
  "9043916": "44789",
  "9043917": "44787",
  "9043918": "44809",
  "9043919": "44866",
  "9043920": "44793",
  "9043921": "44623",
  "9043922": "44625",
  "9043923": "44807",
  "9043924": "45665",
  "9043925": "45659",
  "9043926": "45657",
  "9043927": "45661",
  "9043928": "45892",
  "9043929": "45699",
  "9043930": "45891",
  "9043931": "45881",
  "9043932": "45886",
  "9043933": "45883",
  "9043934": "45141",
  "9043935": "45899",
  "9043936": "45897",
  "9043937": "46238",
  "9043938": "46240",
  "9043939": "45356",
  "9043940": "46149",
  "9043941": "46145",
  "9043942": "46236",
  "9043943": "46244",
  "9043944": "45966",
  "9043945": "45964",
  "9043946": "45894",
  "9043947": "45896",
  "9043948": "45768",
  "9043949": "46284",
  "9043950": "46282",
  "9043951": "46286",
  "9043952": "45721",
  "9043953": "45772",
  "9043954": "45770",
  "9043955": "45739",
  "9043956": "59348",
  "9043957": "45711",
  "9043958": "59399",
  "9043959": "45731",
  "9043960": "59379",
  "9043961": "59394",
  "9043962": "59368",
  "9043963": "59192",
  "9043964": "44534",
  "9043965": "44532",
  "9043966": "44145",
  "9043967": "44328",
  "9043968": "44309",
  "9043969": "59174",
  "9043970": "59425",
  "9043971": "44319",
  "9043972": "59439",
  "9043973": "44287",
  "9043974": "44269",
  "9043975": "44263",
  "9043976": "44141",
  "9043977": "44143",
  "9043978": "44135",
  "9043979": "44265",
  "9043980": "44227",
  "9043981": "44149",
  "9043982": "44379",
  "9043983": "44147",
  "9043984": "44137",
  "9043985": "44139",
  "9043986": "44339",
  "9043987": "44536",
  "9043988": "44579",
  "9043989": "44575",
  "9043990": "44805",
  "9043991": "44388",
  "9043992": "44892",
  "9043993": "44791",
  "9043994": "44803",
  "9043995": "44801",
  "9043996": "58456",
  "9043997": "58452",
  "9043998": "58453",
  "9043999": "58313",
  "9044000": "58089",
  "9044001": "58300",
  "9044002": "58285",
  "9044003": "58256",
  "9044004": "45527",
  "9044005": "42279",
  "9044006": "42389",
  "9044007": "58332",
  "9044008": "42369",
  "9044009": "42855",
  "9044010": "42853",
  "9044011": "42859",
  "9044012": "42899",
  "9044013": "42897",
  "9044014": "42499",
  "9044015": "42477",
  "9044016": "58339",
  "9044017": "51688",
  "9044018": "58553",
  "9044019": "58579",
  "9044020": "58119",
  "9044021": "58135",
  "9044022": "58093",
  "9044023": "58099",
  "9044024": "58097",
  "9044025": "58239",
  "9044026": "58675",
  "9044027": "58809",
  "9044028": "58762",
  "9044029": "58644",
  "9044030": "58511",
  "9044031": "58566",
  "9044032": "58540",
  "9044033": "58791",
  "9044034": "58840",
  "9044035": "57439",
  "9044036": "57413",
  "9044037": "59846",
  "9044038": "58802",
  "9044039": "59821",
  "9044040": "59759",
  "9044041": "59469",
  "9044042": "59457",
  "9044043": "59757",
  "9044044": "58739",
  "9044045": "58706",
  "9044046": "58640",
  "9044047": "58730",
  "9044048": "59423",
  "9044049": "59199",
  "9044050": "59069",
  "9044051": "59077",
  "9044052": "59067",
  "9044053": "59065",
  "9044054": "59075",
  "9044055": "59071",
  "9044056": "59229",
  "9044057": "59514",
  "9044058": "59494",
  "9044059": "59510",
  "9044060": "59269",
  "9044061": "59320",
  "9044062": "59302",
  "9044063": "33428",
  "9044064": "33775",
  "9044065": "48336",
  "9044066": "48361",
  "9044067": "48231",
  "9044068": "48324",
  "9044069": "59227",
  "9044070": "48317",
  "9044071": "48167",
  "9044072": "48165",
  "9044073": "48153",
  "9044074": "48151",
  "9044075": "48163",
  "9044076": "59387",
  "9044077": "48308",
  "9044078": "48159",
  "9044079": "48161",
  "9044080": "48329",
  "9044081": "48341",
  "9044082": "48356",
  "9044083": "48268",
  "9044084": "48149",
  "9044085": "48143",
  "9044086": "48147",
  "9044087": "48145",
  "9044088": "48155",
  "9044089": "48157",
  "9044090": "48291",
  "9044091": "48346",
  "9044092": "49525",
  "9044093": "49545",
  "9044094": "49479",
  "9044095": "49477",
  "9044096": "48369",
  "9044097": "48282",
  "9044098": "48432",
  "9044099": "48429",
  "9044100": "48477",
  "9044103": "48496",
  "9044104": "49509",
  "9044105": "49497",
  "9044113": "49504",
  "9044122": "33829",
  "9044128": "32361",
  "9044129": "32289",
  "9044130": "32339",
  "9044131": "32312",
  "9044132": "32479",
  "9044133": "32278",
  "9044134": "32609",
  "9044135": "32257",
  "9044136": "32130",
  "9044137": "32120",
  "9044138": "32584",
  "9044139": "32049",
  "9044140": "32052",
  "9044141": "32105",
  "9044142": "32107",
  "9044143": "32051",
  "9044144": "33739",
  "9044145": "33824",
  "9044146": "32139",
  "9044148": "33790",
  "9044149": "33803",
  "9044150": "33649",
  "9044151": "33335",
  "9044152": "33332",
  "9044153": "33334",
  "9044154": "33330",
  "9044155": "33442",
  "9044156": "33378",
  "9044157": "33449",
  "9044158": "33415",
  "9044159": "33397",
  "9044160": "33129",
  "9044161": "33758",
  "9044162": "33813",
  "9044163": "33689",
  "9044164": "33659",
  "9044165": "33605",
  "9044166": "33647",
  "9044167": "33617",
  "9044168": "33602",
  "9044169": "33615",
  "9044170": "33609",
  "9044171": "33719",
  "9044172": "33699",
  "9044173": "33818",
  "9044174": "32791",
  "9044175": "32758",
  "9044176": "32756",
  "9044177": "32760",
  "9044178": "32832",
  "9044179": "33161",
  "9044180": "33106",
  "9044181": "33104",
  "9044182": "33102",
  "9044183": "33098",
  "9044184": "33100",
  "9044185": "33175",
  "9044186": "33189",
  "9044187": "33184",
  "9044188": "33014",
  "9044189": "32839",
  "9044190": "32805",
  "9044191": "32825",
  "9044192": "32683",
  "9044193": "32699",
  "9044195": "32694",
  "9044196": "32657",
  "9044197": "32108",
  "9044198": "32602",
  "9044199": "32689",
  "9044200": "32457",
  "9044201": "32549",
  "9044202": "32429",
  "9044203": "32425",
  "9044204": "32423"
}`;

const stadtMap: Record<string, string> = JSON.parse(stadtMapContent);

serve(async (req) => {
  const origin = req.headers.get('origin');
  const corsHeaders = getCorsHeaders(origin);

  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  // Only allow GET requests
  if (req.method !== 'GET') {
    return new Response(
      JSON.stringify({ error: "Method not allowed" }), 
      { status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }

  try {
    const url = new URL(req.url);
    const rawId = url.searchParams.get("id");
    
    // Input validation: ID must exist
    if (!rawId) {
      return new Response(
        JSON.stringify({ error: "ID fehlt" }), 
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Sanitize: only allow digits, max 15 chars
    const id = rawId.replace(/[^0-9]/g, '').substring(0, 15);
    
    if (!id || id.length < 5) {
      return new Response(
        JSON.stringify({ error: "Ung체ltige ID" }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const value = stadtMap[id];
    if (!value) {
      return new Response(
        JSON.stringify({ error: "Unbekannte ID" }),
        { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Pr체fe ob es eine PLZ ist (5 Ziffern)
    const isPlz = /^\d{5}$/.test(value);

    if (isPlz) {
      // PLZ zu Stadt 체ber externe API mit Timeout
      const apiUrl = `https://openplzapi.org/de/Localities?postalCode=${encodeURIComponent(value)}`;
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(apiUrl, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        const data = await response.json();
        const stadt = data?.[0]?.name || null;
        
        if (!stadt) {
          return new Response(
            JSON.stringify({ error: "Stadt nicht gefunden" }),
            { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
          );
        }

        return new Response(
          JSON.stringify({ id, typ: "plz-id", stadt, plz: value }),
          { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        );
      } catch {
        return new Response(
          JSON.stringify({ error: "Externe API nicht erreichbar" }),
          { status: 502, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        );
      }
    } else {
      // Direkter Stadtname
      return new Response(
        JSON.stringify({ id, typ: "stadt-id", stadt: value }),
        { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }
  } catch {
    return new Response(
      JSON.stringify({ error: "Interner Serverfehler" }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});